# KRAFT Config, pausing for now since its creating more issues.

# global:
#   security:
#     allowInsecureImages: true

# kafka:
#   kraft:
#     enabled: true
#     clusterId: "my-cluster-id"

#   controller:
#     replicaCount: 1
#     nodeId: 1
#     extraEnvVars:
#       - name: KAFKA_CFG_PROCESS_ROLES
#         value: "controller"
#       - name: KAFKA_CFG_NODE_ID
#         value: "1"
#       - name: KAFKA_CFG_CONTROLLER_LISTENER_NAMES
#         value: "CONTROLLER"
#       - name: KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP
#         value: "CONTROLLER:PLAINTEXT"
#       - name: KAFKA_CFG_LISTENERS
#         value: "CONTROLLER://:9093"
#       - name: KAFKA_CFG_ADVERTISED_LISTENERS
#         value: "CONTROLLER://kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9093"
#       - name: KAFKA_CFG_CONTROLLER_QUORUM_VOTERS
#         value: "1@kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9093"
#       - name: KAFKA_CFG_CLUSTER_ID
#         value: "my-cluster-id"

#   broker:
#     replicaCount: 1
#     nodeId: 100
#     extraEnvVars:
#       - name: KAFKA_CFG_PROCESS_ROLES
#         value: "broker"
#       - name: KAFKA_CFG_NODE_ID
#         value: "100"
#       - name: KAFKA_CFG_CONTROLLER_QUORUM_VOTERS
#         value: "1@kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9093"
#       - name: KAFKA_CFG_CONTROLLER_LISTENER_NAMES
#         value: "CONTROLLER"

#   image:
#     registry: docker.io
#     repository: bitnamilegacy/kafka
#     tag: 4.0.0-debian-12-r10

#   persistence:
#     enabled: false

#   # ✅ Common configuration for both broker and controller
#   extraEnvVars:
#     - name: KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP
#       value: "CLIENT:SASL_PLAINTEXT,CONTROLLER:PLAINTEXT,INTERNAL:SASL_PLAINTEXT"
#     - name: KAFKA_CFG_LISTENERS
#       value: "CLIENT://:9092,CONTROLLER://:9093,INTERNAL://:9094"
#     - name: KAFKA_CFG_ADVERTISED_LISTENERS
#       value: "CLIENT://kafka-broker-0.kafka-broker-headless.kafka.svc.cluster.local:9092,INTERNAL://kafka-broker-0.kafka-broker-headless.kafka.svc.cluster.local:9094"
#     - name: KAFKA_CFG_INTER_BROKER_LISTENER_NAME
#       value: "INTERNAL"
#     - name: KAFKA_CFG_SASL_ENABLED_MECHANISMS
#       value: "PLAIN"
#     - name: KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL
#       value: "PLAIN"
#     - name: KAFKA_OPTS
#       value: "-Djava.security.auth.login.config=/opt/bitnami/kafka/config/kafka_jaas.conf"


# global:
#   security:
#     allowInsecureImages: true

# zookeeper:
#   enabled: true
#   replicaCount: 1
#   image:
#     registry: docker.io
#     repository: bitnamilegacy/zookeeper
#     tag: 3.9.1-debian-10-r22  # pick actual tag from legacy repo
#   auth:
#     enabled: false
#   persistence:
#     enabled: false
#   service:
#     type: ClusterIP
#   resources:
#     requests:
#       memory: 128Mi
#       cpu: 100m

# kafka:
#   kraft:
#     enabled: false  # ✅ Using Zookeeper mode

#   replicaCount: 1

#   image:
#     registry: docker.io
#     repository: bitnamilegacy/kafka
#     tag: 4.0.0-debian-12-r10

#   persistence:
#     enabled: false

#   auth:
#     clientProtocol: plaintext
#     interBrokerProtocol: plaintext

#   configurationOverrides:
#     listeners: PLAINTEXT://:9092
#     advertised.listeners: PLAINTEXT://kafka-0.kafka-headless.kafka.svc.cluster.local:9092
#     listener.security.protocol.map: PLAINTEXT:PLAINTEXT
#     inter.broker.listener.name: PLAINTEXT
#     zookeeper.connect: zookeeper.kafka.svc.cluster.local:2181
#     auto.create.topics.enable: "true"
#     delete.topic.enable: "true"
#     log.retention.hours: "168"
#     offsets.topic.replication.factor: "1"
#     transaction.state.log.replication.factor: "1"
#     transaction.state.log.min.isr: "1"
#     group.initial.rebalance.delay.ms: "0"

#   service:
#     type: ClusterIP
#     ports:
#       client: 9092
#       interbroker: 9094
#       controller: 9093
#     headless:
#       enabled: true

#   metrics:
#     kafka:
#       enabled: false
#     jmx:
#       enabled: false

#   resources:
#     requests:
#       memory: 256Mi
#       cpu: 200m



# this is without sasl 
# global:
#   security:
#     allowInsecureImages: true

# kafka:
#   kraft:
#     enabled: true
#     clusterId: "my-cluster-id"

#   controller:
#     replicaCount: 1
#     nodeId: 1
#     extraEnvVars:
#       - name: KAFKA_CFG_PROCESS_ROLES
#         value: "controller"
#       - name: KAFKA_CFG_NODE_ID
#         value: "1"
#       - name: KAFKA_CFG_CONTROLLER_LISTENER_NAMES
#         value: "CONTROLLER"
#       - name: KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP
#         value: "CONTROLLER:PLAINTEXT,CLIENT:PLAINTEXT,INTERNAL:PLAINTEXT"
#       - name: KAFKA_CFG_INTER_BROKER_LISTENER_NAME
#         value: "INTERNAL"
#       # --- START CORRECTIONS FOR SASL/PLAINTEXT ---
#       # Although you set these to empty, the chart forces SASL, so we must explicitly define the needed credentials.
#       - name: KAFKA_CFG_SECURITY_PROTOCOL
#         value: "PLAINTEXT"
#       - name: KAFKA_CFG_SASL_ENABLED_MECHANISMS
#         value: "PLAIN" # Explicitly enable PLAIN to match generated configs
#       - name: KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL
#         value: "PLAIN"
#       # JAAS config for *this controller* to connect to *other brokers/controllers* (using the INTER_BROKER user)
#       # - name: KAFKA_OPTS
#       #   value: >-
#       #     -Djava.security.auth.login.config=/dev/null 
#       #     -Dkafka.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required 
#       #     username="inter_broker_user" password="qa9wYfamFF";
#       # --- END CORRECTIONS ---
#       - name: KAFKA_CFG_LISTENERS
#         value: "CONTROLLER://:9093,CLIENT://:9092,INTERNAL://:9094"
#       - name: KAFKA_CFG_ADVERTISED_LISTENERS
#         value: "CONTROLLER://kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9093,CLIENT://kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9092,INTERNAL://kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9094"
#       - name: KAFKA_CFG_CONTROLLER_QUORUM_VOTERS
#         value: "1@kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9093"

#   broker:
#     replicaCount: 1
#     # NOTE: nodeId 100 is static. If scaling past 1, this must be made dynamic or unique.
#     nodeId: 100 
#     extraEnvVars:
#       - name: ALLOW_PLAINTEXT_LISTENER
#         value: "yes"
#       - name: KAFKA_CFG_PROCESS_ROLES
#         value: "broker"
#       - name: KAFKA_CFG_NODE_ID
#         value: "100"
#       - name: KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP
#         value: "CONTROLLER:PLAINTEXT,CLIENT:PLAINTEXT,INTERNAL:PLAINTEXT"
#       - name: KAFKA_CFG_INTER_BROKER_LISTENER_NAME
#         value: "INTERNAL"
#       # --- START CORRECTIONS FOR SASL/PLAINTEXT ---
#       - name: KAFKA_CFG_SECURITY_PROTOCOL
#         value: "PLAINTEXT"
#       - name: KAFKA_CFG_SASL_ENABLED_MECHANISMS
#         value: "PLAIN" # Explicitly enable PLAIN to match generated configs
#       - name: KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL
#         value: "PLAIN"
#       # JAAS config for *this broker* to connect to *the controller* (using the INTER_BROKER user)
#       # - name: KAFKA_OPTS
#       #   value: >-
#       #     -Djava.security.auth.login.config=/dev/null 
#       #     -Dkafka.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required 
#       #     username="inter_broker_user" password="qa9wYfamFF";
#       # --- END CORRECTIONS ---
#       # --- START CORRECTIONS FOR LISTENERS ---
#       # Broker only needs CLIENT and INTERNAL listeners. The CONTROLLER is redundant here.
#       - name: KAFKA_CFG_LISTENERS
#         value: "CLIENT://:9092,INTERNAL://:9094"
#       - name: KAFKA_CFG_ADVERTISED_LISTENERS
#         value: "CLIENT://kafka-broker-0.kafka-broker-headless.kafka.svc.cluster.local:9092,INTERNAL://kafka-broker-0.kafka-broker-headless.kafka.svc.cluster.local:9094"
#       # --- END CORRECTIONS ---
#       - name: KAFKA_CFG_CONTROLLER_QUORUM_VOTERS
#         value: "1@kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9093"

#   image:
#     registry: docker.io
#     repository: bitnamilegacy/kafka
#     tag: 4.0.0-debian-12-r10

#   persistence:
#     enabled: false




fullnameOverride: kafka

kafka:
  image:
    registry: docker.io
    repository: bitnamilegacy/kafka
    tag: 4.0.0-debian-12-r10
    pullPolicy: IfNotPresent

  replicaCount: 1

  # Enable KRaft with both roles (controller + broker)
  kraft:
    enabled: true
    roles: controller,broker
    controllerQuorumVoters: 0@kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9093

  persistence:
    enabled: false

  # Define all listeners (CLIENT, CONTROLLER, INTERNAL)
  listeners:
    client:
      protocol: PLAINTEXT
    controller:
      protocol: PLAINTEXT
    interbroker:
      protocol: PLAINTEXT

  # Define advertised listeners for clients, controller, and interbroker
  advertisedListeners:
    client:
      name: CLIENT
      address: kafka-broker-0.kafka-broker-headless.kafka.svc.cluster.local
      port: 9092
    internal:
      name: INTERNAL
      address: kafka-broker-0.kafka-broker-headless.kafka.svc.cluster.local
      port: 9094
    controller:
      name: CONTROLLER
      address: kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local
      port: 9093

  auth:
    clientProtocol: PLAINTEXT
    interBrokerProtocol: PLAINTEXT
    controllerProtocol: PLAINTEXT

  heapOpts: "-Xmx512m -Xms512m"
  logLevel: INFO

  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 20

  readinessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10

  podSecurityContext:
    enabled: false
  containerSecurityContext:
    enabled: false

  extraEnvVars:
  - name: KAFKA_CFG_group.coordinator.state.topic.replication.factor
    value: "1"
  - name: KAFKA_CFG_share.coordinator.state.topic.replication.factor
    value: "1"
  # optional: keep partitions same as default
  - name: KAFKA_CFG_group.coordinator.state.topic.num.partitions
    value: "50"
  - name: KAFKA_CFG_share.coordinator.state.topic.num.partitions
    value: "50"

  service:
    type: ClusterIP
    ports:
      client: 9092
      controller: 9093
      internal: 9094

  headlessService:
    enabled: true

  networkPolicy:
    enabled: false

metrics:
  jmx:
    enabled: false

